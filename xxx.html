<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" id="favicon" href="" />
    <meta name="description" id="metaDescription" content="" />
    <title id="pageTitle">内容加载中...</title>
    <meta property="og:title" id="ogTitle" content="" />
    <meta property="og:description" id="ogDescription" content="" />
    <meta property="og:image" id="ogImage" content="" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .loader {
                @apply animate-spin h-12 w-12 border-2 border-green-500 border-t-transparent rounded-full;
            }
        }
    </style>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        #contentFrame {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 加载状态 -->
    <div id="loaderContainer" class="fixed inset-0 flex flex-col justify-center items-center bg-white z-50">
        <div class="loader mb-4"></div>
        <h1 class="text-xl font-semibold text-gray-800">正在加载内容...</h1>
    </div>
    
    <!-- 内容容器 -->
    <div id="contentContainer" class="hidden">
        <iframe id="contentFrame" class="border-0" 
                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                title="内嵌网页内容"></iframe>
    </div>
    
    <!-- 错误信息 -->
    <div id="errorContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center bg-white z-50 p-6 text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">加载失败</h3>
        <p id="errorMessage" class="text-gray-500 mb-6">无法加载请求的内容，请检查链接是否有效</p>
        <button id="retryBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors">
            重试
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></script>
    <script>
        // 从URL中提取ID参数，兼容多种URL格式
        function extractIdFromUrl() {
            // 尝试从查询参数中获取id
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            
            // 如果查询参数中没有id，尝试从URL路径中提取数字ID
            if (!id) {
                // 匹配URL中可能包含的数字ID模式
                const pathMatch = window.location.href.match(/id=(\d+)|(\d+)(?=\.\w+$)/);
                if (pathMatch) {
                    // 提取第一个匹配的数字ID
                    id = pathMatch[1] || pathMatch[2];
                }
            }
            
            return id;
        }
        
        // 更新页面元数据和标题信息
        function updatePageMetadata(data) {
            // 更新标题
            document.getElementById('pageTitle').textContent = data.title || '内容加载中...';
            document.getElementById('ogTitle').content = data.title || '';
            
            // 更新描述
            const description = data.subtitle || '正在加载内容...';
            document.getElementById('metaDescription').content = description;
            document.getElementById('ogDescription').content = description;
            
            // 更新封面图片
            if (data.cover_image) {
                document.getElementById('ogImage').content = data.cover_image;
                // 尝试设置favicon，如果封面图存在
                document.getElementById('favicon').href = data.cover_image;
            }
        }
        
        // 从API获取URL并加载内容
        async function loadContent() {
            // 使用新的ID提取函数
            const id = extractIdFromUrl();
            const loaderContainer = document.getElementById('loaderContainer');
            const contentContainer = document.getElementById('contentContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const contentFrame = document.getElementById('contentFrame');
            
            // 显示加载状态
            loaderContainer.classList.remove('hidden');
            contentContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            
            if (!id) {
                // 没有ID参数
                setTimeout(() => {
                    loaderContainer.classList.add('hidden');
                    errorMessage.textContent = '未找到有效的ID参数，请检查链接是否正确';
                    errorContainer.classList.remove('hidden');
                }, 1000);
                return;
            }
            
            try {
                // 调用API获取URL和元数据
                const apiUrl = `https://wxurl.qihaobao.com/get_url.php?id=${id}`;
                
                // 设置超时时间为10秒
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('连接超时')), 10000)
                );
                
                const response = await Promise.race([
                    fetch(apiUrl),
                    timeoutPromise
                ]);
                
                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success || !data.url) {
                    throw new Error(data.message || '未找到对应的内容');
                }
                
                // 更新页面元数据（标题、副标题、封面图）
                updatePageMetadata(data);
                
                // 加载获取到的URL
                contentFrame.src = data.url;
                
                // 等待iframe加载完成
                await new Promise((resolve, reject) => {
                    // 设置iframe加载超时
                    const iframeTimeout = setTimeout(() => {
                        reject(new Error('内容加载超时'));
                    }, 15000);
                    
                    contentFrame.onload = () => {
                        clearTimeout(iframeTimeout);
                        resolve();
                    };
                    
                    contentFrame.onerror = () => {
                        clearTimeout(iframeTimeout);
                        reject(new Error('内容加载失败'));
                    };
                });
                
                // 加载成功，显示内容
                loaderContainer.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                
            } catch (error) {
                console.error('加载失败:', error);
                loaderContainer.classList.add('hidden');
                
                // 显示错误信息
                if (error.message.includes('超时')) {
                    errorMessage.textContent = '操作超时，请检查网络连接或稍后重试';
                } else if (error.message.includes('未找到')) {
                    errorMessage.textContent = `未找到ID为 ${id} 的内容`;
                } else {
                    errorMessage.textContent = `加载失败: ${error.message}`;
                }
                
                errorContainer.classList.remove('hidden');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载内容
            loadContent();
            
            // 重试按钮事件
            document.getElementById('retryBtn').addEventListener('click', loadContent);
        });
    </script>
</body>
</html>
    